---
# Ingress for the API Gateway with TLS termination
# This example uses nginx-ingress, adjust for your ingress controller
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-gateway
  labels:
    app: api-gateway
    component: gateway
  annotations:
    # Nginx Ingress Controller annotations
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # Rate limiting at ingress level (optional, gateway has its own)
    nginx.ingress.kubernetes.io/limit-rps: "100"

    # Connection and timeout settings
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "5"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"

    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";

    # CORS settings (adjust as needed)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # Client body size limit
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

    # Connection keep-alive
    nginx.ingress.kubernetes.io/upstream-keepalive-connections: "50"

    # For cert-manager automatic certificate provisioning
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

spec:
  ingressClassName: nginx

  # TLS configuration
  tls:
  - hosts:
    - api.example.com
    - gateway.example.com
    secretName: api-gateway-tls

  rules:
  # Main API endpoint
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              name: http

  # Alternative gateway endpoint
  - host: gateway.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              name: http

---
# TLS Certificate (if not using cert-manager)
# Create this secret manually or use cert-manager
apiVersion: v1
kind: Secret
metadata:
  name: api-gateway-tls
  labels:
    app: api-gateway
    component: gateway
type: kubernetes.io/tls
data:
  # Base64 encoded TLS certificate
  tls.crt: <BASE64_ENCODED_CERTIFICATE>
  # Base64 encoded TLS private key
  tls.key: <BASE64_ENCODED_PRIVATE_KEY>

---
# Certificate resource for cert-manager (if using cert-manager)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: api-gateway-tls
  labels:
    app: api-gateway
    component: gateway
spec:
  secretName: api-gateway-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - api.example.com
  - gateway.example.com
  usages:
  - digital signature
  - key encipherment
