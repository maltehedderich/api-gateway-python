---
# HorizontalPodAutoscaler for the API Gateway
# Automatically scales the number of pods based on CPU and memory usage
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-gateway
  labels:
    app: api-gateway
    component: gateway
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api-gateway

  minReplicas: 3
  maxReplicas: 10

  # Scaling behavior configuration
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # Wait 5 minutes before scaling down
      policies:
      - type: Percent
        value: 50  # Scale down by at most 50% of current pods
        periodSeconds: 60
      - type: Pods
        value: 2  # Or scale down by at most 2 pods
        periodSeconds: 60
      selectPolicy: Min  # Use the policy that results in slower scale-down

    scaleUp:
      stabilizationWindowSeconds: 0  # Scale up immediately
      policies:
      - type: Percent
        value: 100  # Scale up by at most 100% of current pods
        periodSeconds: 15
      - type: Pods
        value: 4  # Or scale up by at most 4 pods
        periodSeconds: 15
      selectPolicy: Max  # Use the policy that results in faster scale-up

  # Metrics to use for autoscaling
  metrics:
  # CPU utilization target
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # Target 70% CPU usage

  # Memory utilization target
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80  # Target 80% memory usage

---
# PodDisruptionBudget to ensure high availability during disruptions
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: api-gateway
  labels:
    app: api-gateway
    component: gateway
spec:
  minAvailable: 2  # Always keep at least 2 pods running
  selector:
    matchLabels:
      app: api-gateway

  # Alternative: use maxUnavailable instead
  # maxUnavailable: 1  # Allow at most 1 pod to be unavailable
